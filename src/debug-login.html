<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•è°ƒè¯•æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        button { padding: 10px; margin: 5px; }
        input { padding: 5px; margin: 5px; }
    </style>
</head>
<body>
    <h1>ç™»å½•é€»è¾‘è°ƒè¯•æµ‹è¯•</h1>

    <div class="debug-section">
        <h3>1. åŸºç¡€æµ‹è¯•</h3>
        <button onclick="testBasicFlow()">æµ‹è¯•åŸºç¡€æµç¨‹</button>
        <div id="basicResult"></div>
    </div>

    <div class="debug-section">
        <h3>2. DOMå…ƒç´ æµ‹è¯•</h3>
        <button onclick="testDOMElements()">æµ‹è¯•DOMå…ƒç´ </button>
        <div id="domResult"></div>
    </div>

    <div class="debug-section">
        <h3>3. æ¨¡æ‹Ÿç™»å½•æµ‹è¯•</h3>
        <input type="text" id="testUsername" placeholder="ç”¨æˆ·å" value="admin">
        <input type="password" id="testPassword" placeholder="å¯†ç " value="password">
        <button onclick="testLogin()">æ¨¡æ‹Ÿç™»å½•</button>
        <div id="loginResult"></div>
    </div>

    <div class="debug-section">
        <h3>4. TokenéªŒè¯æµ‹è¯•</h3>
        <button onclick="testTokenVerify()">æµ‹è¯•TokenéªŒè¯</button>
        <div id="tokenResult"></div>
    </div>

    <script>
        // æ¨¡æ‹ŸDailyReportManagerç±»çš„æ ¸å¿ƒé€»è¾‘
        class TestDailyReportManager {
            constructor() {
                this.apiBase = window.location.hostname === 'localhost'
                    ? 'http://localhost:3002/api'
                    : '/api';
                this.token = localStorage.getItem('authToken');
                this.currentUser = null;
                this.reports = [];
                this.currentReport = null;
            }

            async apiRequest(endpoint, options = {}) {
                const url = `${this.apiBase}${endpoint}`;
                const defaultOptions = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...(this.token && { Authorization: `Bearer ${this.token}` })
                    }
                };

                console.log(`ğŸ“¡ APIè¯·æ±‚: ${url}`, options);

                try {
                    const response = await fetch(url, { ...defaultOptions, ...options });
                    console.log(`ğŸ“¡ APIå“åº”çŠ¶æ€: ${response.status}`);

                    if (response.status === 401) {
                        this.logout();
                        throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                    }

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'è¯·æ±‚å¤±è´¥');
                    }

                    const data = await response.json();
                    console.log(`ğŸ“¡ APIå“åº”æ•°æ®:`, data);
                    return data;
                } catch (error) {
                    console.error(`âŒ APIè¯·æ±‚å¤±è´¥:`, error);
                    throw error;
                }
            }

            async login(username, password) {
                try {
                    console.log(`ğŸ”‘ å°è¯•ç™»å½•: ${username}`);
                    const data = await this.apiRequest('/login', {
                        method: 'POST',
                        body: JSON.stringify({ username, password })
                    });

                    console.log(`âœ… ç™»å½•æˆåŠŸï¼Œè·å¾—token:`, data.token ? 'æ˜¯' : 'å¦');
                    console.log(`ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯:`, data.user);

                    this.token = data.token;
                    this.currentUser = data.user;
                    localStorage.setItem('authToken', this.token);

                    return data;
                } catch (error) {
                    console.error(`âŒ ç™»å½•å¤±è´¥:`, error.message);
                    throw error;
                }
            }

            async verifyToken() {
                try {
                    console.log(`ğŸ” éªŒè¯token:`, this.token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                    const data = await this.apiRequest('/verify');
                    this.currentUser = data.user;
                    console.log('âœ… TokenéªŒè¯æˆåŠŸï¼Œç”¨æˆ·:', this.currentUser);
                    return { success: true, user: data.user };
                } catch (error) {
                    console.error('âŒ TokenéªŒè¯å¤±è´¥:', error);
                    this.logout();
                    return { success: false, error: error.message };
                }
            }

            logout() {
                console.log(`ğŸšª ç”¨æˆ·é€€å‡ºç™»å½•`);
                this.token = null;
                this.currentUser = null;
                localStorage.removeItem('authToken');
            }

            showMainApp() {
                console.log('ğŸ¯ æ˜¾ç¤ºä¸»åº”ç”¨ï¼Œå½“å‰ç”¨æˆ·:', this.currentUser);
                return { success: true, user: this.currentUser };
            }

            showReadOnlyMode() {
                console.log('ğŸ“– æ˜¾ç¤ºåªè¯»æ¨¡å¼');
                return { success: true, mode: 'readonly' };
            }
        }

        let testApp;

        function log(divId, message, type = 'info') {
            const div = document.getElementById(divId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            div.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>`;
        }

        function testBasicFlow() {
            const resultDiv = document.getElementById('basicResult');
            resultDiv.innerHTML = '';

            try {
                testApp = new TestDailyReportManager();
                log('basicResult', 'âœ… DailyReportManagerå®ä¾‹åˆ›å»ºæˆåŠŸ', 'success');
                log('basicResult', `ğŸ“ API Base: ${testApp.apiBase}`, 'info');
                log('basicResult', `ğŸ”‘ å½“å‰Token: ${testApp.token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, 'info');
                log('basicResult', `ğŸ‘¤ å½“å‰ç”¨æˆ·: ${testApp.currentUser ? testApp.currentUser.username : 'æœªç™»å½•'}`, 'info');
            } catch (error) {
                log('basicResult', `âŒ åŸºç¡€æµç¨‹æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function testDOMElements() {
            const resultDiv = document.getElementById('domResult');
            resultDiv.innerHTML = '';

            // æ¨¡æ‹Ÿæ£€æµ‹å…³é”®DOMå…ƒç´ 
            const criticalElements = [
                'loginPage',
                'app',
                'currentUser',
                'createReportBtn',
                'loginBtn',
                'logoutBtn'
            ];

            criticalElements.forEach(elementId => {
                try {
                    // åœ¨æµ‹è¯•é¡µé¢ä¸­è¿™äº›å…ƒç´ ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿæ£€æµ‹
                    const exists = document.getElementById(elementId) !== null;
                    log('domResult', `${exists ? 'âœ…' : 'âŒ'} DOMå…ƒç´  #${elementId}: ${exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, exists ? 'success' : 'error');
                } catch (error) {
                    log('domResult', `âŒ æ£€æµ‹DOMå…ƒç´  #${elementId}å¤±è´¥: ${error.message}`, 'error');
                }
            });
        }

        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = '';

            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;

            if (!testApp) {
                testApp = new TestDailyReportManager();
            }

            try {
                log('loginResult', `ğŸš€ å¼€å§‹ç™»å½•æµ‹è¯•: ${username}`, 'info');

                const loginResult = await testApp.login(username, password);
                log('loginResult', 'âœ… ç™»å½•APIè°ƒç”¨æˆåŠŸ', 'success');
                log('loginResult', `ğŸ‘¤ ç”¨æˆ·å: ${loginResult.user?.username || 'æœªçŸ¥'}`, 'info');
                log('loginResult', `ğŸ”‘ Tokenå­˜å‚¨: ${testApp.token ? 'æˆåŠŸ' : 'å¤±è´¥'}`, testApp.token ? 'success' : 'error');

                // æµ‹è¯•æ˜¾ç¤ºä¸»åº”ç”¨
                const showResult = testApp.showMainApp();
                log('loginResult', `ğŸ¯ æ˜¾ç¤ºä¸»åº”ç”¨: ${showResult.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, showResult.success ? 'success' : 'error');

            } catch (error) {
                log('loginResult', `âŒ ç™»å½•æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                log('loginResult', `ğŸ’¡ è¿™å¯èƒ½æ˜¯ç”±äºAPIæœåŠ¡å™¨æœªè¿è¡Œæˆ–å‡­è¯é”™è¯¯`, 'info');
            }
        }

        async function testTokenVerify() {
            const resultDiv = document.getElementById('tokenResult');
            resultDiv.innerHTML = '';

            if (!testApp) {
                testApp = new TestDailyReportManager();
            }

            try {
                log('tokenResult', 'ğŸ” å¼€å§‹TokenéªŒè¯æµ‹è¯•', 'info');
                log('tokenResult', `ğŸ”‘ å½“å‰Token: ${testApp.token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, testApp.token ? 'success' : 'error');

                if (testApp.token) {
                    const verifyResult = await testApp.verifyToken();
                    if (verifyResult.success) {
                        log('tokenResult', 'âœ… TokenéªŒè¯æˆåŠŸ', 'success');
                        log('tokenResult', `ğŸ‘¤ ç”¨æˆ·: ${verifyResult.user?.username || 'æœªçŸ¥'}`, 'info');

                        // æµ‹è¯•æ˜¾ç¤ºä¸»åº”ç”¨
                        const showResult = testApp.showMainApp();
                        log('tokenResult', `ğŸ¯ æ˜¾ç¤ºä¸»åº”ç”¨: ${showResult.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, showResult.success ? 'success' : 'error');
                    } else {
                        log('tokenResult', `âŒ TokenéªŒè¯å¤±è´¥: ${verifyResult.error}`, 'error');
                    }
                } else {
                    log('tokenResult', 'âš ï¸ æ²¡æœ‰Tokenå¯ä»¥éªŒè¯ï¼Œæ˜¾ç¤ºåªè¯»æ¨¡å¼', 'info');
                    const readOnlyResult = testApp.showReadOnlyMode();
                    log('tokenResult', `ğŸ“– æ˜¾ç¤ºåªè¯»æ¨¡å¼: ${readOnlyResult.success ? 'æˆåŠŸ' : 'å¤±è´¥'}`, readOnlyResult.success ? 'success' : 'error');
                }

            } catch (error) {
                log('tokenResult', `âŒ TokenéªŒè¯æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('DOMContentLoaded', () => {
            testBasicFlow();
        });
    </script>
</body>
</html>